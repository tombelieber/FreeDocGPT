from __future__ import annotations

from typing import Dict

import streamlit as st


# Minimal translation catalog (expand as needed)
SUPPORTED_LOCALES = ["en", "zh-Hant", "zh-Hans", "es", "ja"]


def normalize_locale(code: str | None) -> str:
    if not code:
        return "en"
    s = str(code).strip()
    if not s:
        return "en"
    l = s.lower().replace("_", "-")
    # Direct matches
    if l in ("en", "es", "ja", "zh-hant", "zh-hans"):
        return {"zh-hant": "zh-Hant", "zh-hans": "zh-Hans"}.get(l, l)
    # English
    if l.startswith("en"):
        return "en"
    # Spanish
    if l.startswith("es"):
        return "es"
    # Japanese
    if l.startswith("ja") or l.startswith("jp"):
        return "ja"
    # Chinese
    if l.startswith("zh"):
        if "hant" in l or any(x in l for x in ("tw", "hk", "mo")):
            return "zh-Hant"
        if "hans" in l or any(x in l for x in ("cn", "sg", "my")):
            return "zh-Hans"
        # default ambiguous zh to Traditional (can be adjusted)
        return "zh-Hant"
    # Fallback
    return "en"


_TRANSLATIONS: Dict[str, Dict[str, str]] = {
    "en": {
        "app.subtitle": "Free, local document buddy — drop files in `documents/` and start asking questions.",
        "sidebar.document_management": "📁 Document Management",
        "sidebar.documents_folder": "📂 Documents folder: `./{folder}/`",
        "sidebar.index_new_docs": "🔄 Index New Documents",
        "sidebar.found_docs": "Found {count} document(s)",
        "sidebar.auto_detect": "🤖 AI-Powered Auto-Detection",
        "sidebar.auto_detect_help": "Uses LLM to detect document types and languages.",
        "sidebar.auto_detect_caption1": "✨ AI analyzes each document to tune processing",
        "sidebar.auto_detect_caption2": "🌐 Supports English, 中文 (简/繁), Español, 日本語",
        "sidebar.no_docs_found": "No documents found in `./{folder}/`",
        "sidebar.supported_formats_title": "Supported formats:",
        "sidebar.vision_support_title": "🎨 Vision Support:",
        "sidebar.vision_support_detail": "✅ PDF images, charts, and diagrams via LLaVA",
        "sidebar.indexed_docs": "📊 Indexed Documents",
        "sidebar.reset_index": "🧹 Reset Index",
        "sidebar.reset_index_help": "Drop LanceDB table and clear Tantivy index",
        "sidebar.no_index_yet": "No documents indexed yet",
        "sidebar.total_chunks": "Total Chunks",
        "sidebar.reset_ok": "Index reset completed.",
        "sidebar.reset_fail": "Failed to reset index. You can manually delete the .lancedb folder and reload.",
        "sidebar.tantivy_warn": "Tantivy clear warning: {err}",
        "search.header": "🔍 Search Settings",
        "search.mode": "Search Mode",
        "search.mode_help": "Choose search strategy: Hybrid combines keyword and vector search",
        "search.alpha_label": "Vector vs Keyword Weight",
        "search.alpha_help": "0 = Pure keyword search, 1 = Pure vector search, 0.5 = Balanced",
        "search.results_label": "Number of Results",
        "search.results_help": "Number of document chunks to retrieve",
        "search.weight_caption": "📝 Keyword: {kw}% | 🎯 Vector: {vec}%",
        "chat.header": "💬 Ask Questions",
        "chat.input": "Ask a question about your documents...",
        "buttons.clear_chat": "🔄 Clear Chat",
        "chat.response_metrics": "📊 Response Metrics",
        "chat.metrics_total_time": "Total time: {secs:.2f}s",
        "chat.metrics_first_token": "First token: {secs:.2f}s",
        "chat.metrics_tokens": "Tokens: {count}",
        "chat.metrics_speed": "Speed: {rate:.1f} tokens/sec",
        "footer.embedding_model": "Embedding Model:",
        "footer.generation_model": "Generation Model:",
        "chat.metric_response_time": "⏱️ Response Time",
        "chat.metric_first_token": "🚀 First Token",
        "chat.metric_tokens": "📝 Tokens",
        "chat.metric_speed": "⚡ Speed",
        "chat.searching": "🔍 Searching through documents...",
        "chat.found_chunks": "✅ Found {count} relevant chunks in {secs:.2f}s",
        "chat.found_chunks_hybrid": " (Hybrid: {kw} keyword + {vec} vector)",
        "chat.found_chunks_keyword": " (Keyword: {kw} results)",
        "chat.found_chunks_vector": " (Vector: {vec} results)",
        "chat.sources": "📖 Sources",
        "chat.search_completed": "Search completed in {secs:.2f} seconds using {mode} mode",
        "chat.thinking": "🤔 Thinking...",
        "chat.streaming": "🔄 Streaming...",
        "chat.complete": "✅ Complete",
        "chat.error_generating": "Error generating response: {err}",
        "chat.no_relevant": "I couldn't find any relevant information in the indexed documents. Please make sure documents are indexed.",
        "chat.no_relevant_title": "⚠️ No relevant documents found",
        "lang.selector": "🌐 Language / 語言 / 语言",
        "lang.en": "English",
        "lang.zh_hant": "繁體中文",
        "lang.zh_hans": "简体中文",
        "lang.es": "Español",
        "lang.ja": "日本語",

        # Settings panel
        "settings.title": "⚙️ Settings",
        "settings.doc_processing": "📊 Document Processing Settings",
        "settings.quick_presets": "🎯 Quick Presets",
        "settings.quick_presets_caption": "Optimized for common docs: Notion/Lark exports, PDFs, tech docs",
        "settings.preset_meeting": "📝 Meeting Notes",
        "settings.preset_prd": "📋 PRD/Specs",
        "settings.preset_tech": "💻 Tech Docs",
        "settings.preset_wiki": "📚 Wiki/KB",
        "settings.preset_applied_meeting": "📝 Applied Meeting Notes preset",
        "settings.preset_applied_prd": "📋 Applied PRD/Specs preset",
        "settings.preset_applied_tech": "💻 Applied Tech Docs preset",
        "settings.preset_applied_wiki": "📚 Applied Wiki/KB preset",
        "settings.chunk_size": "📏 Chunk Size (characters per segment)",
        "settings.chunk_help": "For Notion/Lark docs with mixed content, 1500-1800 is recommended.",
        "settings.overlap_size": "🔄 Overlap Size (shared text between chunks)",
        "settings.overlap_help": "For documents with code blocks, use 300-400.",
        "settings.results": "🔍 Search Results (number of relevant segments)",
        "settings.results_help": "For technical queries use 5-7, for simple Q&A use 3-5.",
        "settings.current_config": "📊 Current Configuration",
        "settings.metric_chunk": "Chunk Size",
        "settings.metric_overlap": "Overlap",
        "settings.metric_results": "Results",
        "settings.small_good": "⚠️ Small: Good for Q&A",
        "settings.large_good": "📦 Large: Good for code",
        "settings.balanced": "✅ Balanced",
        "settings.overlap_pct": "{pct:.0f}% of chunk size",
        "settings.focused": "🎯 Focused search",
        "settings.comprehensive": "🌐 Comprehensive",
        "settings.best_practices": "💡 Best Practices",
        "settings.bp_notion_title": "📌 For Notion/Lark Export:",
        "settings.bp_notion_list": "- Export as Markdown (.md) for best results\n- Notion: Settings → Export → Markdown & CSV\n- Lark/Feishu: More → Export → Markdown",
        "settings.bp_reco_title": "📊 Recommended Settings:",
        "settings.bp_reco_list": "- Meeting Notes: 600-800 chunk, 100 overlap\n- PRD/Specs: 1500 chunk, 300 overlap\n- Tech Docs: 1800 chunk, 400 overlap\n- Wiki/How-to: 1200 chunk, 200 overlap",
        "settings.prompt": "Prompt",
        "settings.prompt_active": "Active system prompt file:",
        "settings.preview_first300": "Preview first 300 chars",
        "settings.prompt_not_found": "Prompt file not found; using default built-in prompt.",
        "settings.prompt_could_not_read": "Could not read prompt file: {err}",
        "settings.reload_prompt": "🔁 Reload System Prompt",
        "settings.reload_ok": "System prompt reloaded.",
        "settings.reload_fail": "Failed to reload prompt: {err}",
        "settings.reload_na": "Search service not available to reload prompt.",
        "settings.models": "Models",
        "settings.ollama_prereq": "⚠️ Prerequisites Required:\n1. Install Ollama: `brew install ollama`\n2. Start Ollama: `ollama serve`\n3. Pull required models:\n   - `ollama pull embeddinggemma:300m`\n   - `ollama pull gpt-oss:20b`",
        "settings.embed_model": "Embedding Model",
        "settings.gen_model": "Generation Model",
        "settings.model_help": "Make sure this model is installed in Ollama",
        "settings.check_ollama": "🔍 Check Ollama Status",
    },
    "zh-Hant": {
        "app.subtitle": "免費、本地的文件夥伴——把檔案放進 `documents/` 就能開始發問。",
        "sidebar.document_management": "📁 檔案管理",
        "sidebar.documents_folder": "📂 檔案資料夾：`./{folder}/`",
        "sidebar.index_new_docs": "🔄 建立新索引",
        "sidebar.found_docs": "找到 {count} 份檔案",
        "sidebar.auto_detect": "🤖 AI 智能自動辨識",
        "sidebar.auto_detect_help": "使用 LLM 辨識文件類型與語言。",
        "sidebar.auto_detect_caption1": "✨ AI 會分析每份檔案並自動調整處理設定",
        "sidebar.auto_detect_caption2": "🌐 支援 English / 简体中文 / 繁體中文 / Español / 日本語 及混合內容",
        "sidebar.no_docs_found": "在 `./{folder}/` 找不到檔案",
        "sidebar.supported_formats_title": "支援格式：",
        "sidebar.vision_support_title": "🎨 影像辨識：",
        "sidebar.vision_support_detail": "✅ 透過 LLaVA 處理 PDF 圖像、圖表與截圖",
        "sidebar.supported_formats_list": "PDF、Word、Markdown、HTML、CSV、Excel、JSON、TXT 等",
        "sidebar.indexed_docs": "📊 已索引檔案",
        "sidebar.reset_index": "🧹 重設索引",
        "sidebar.reset_index_help": "清除 LanceDB 資料表並重置 Tantivy 索引",
        "sidebar.no_index_yet": "尚未建立任何索引",
        "sidebar.total_chunks": "總片段數",
        "sidebar.reset_ok": "索引已重設。",
        "sidebar.reset_fail": "重設失敗。你也可以手動刪除 .lancedb 資料夾後重新載入。",
        "sidebar.tantivy_warn": "Tantivy 清除警告：{err}",
        "search.header": "🔍 搜尋設定",
        "search.mode": "搜尋模式",
        "search.mode_help": "混合搜尋同時使用關鍵字與向量，比較聰明",
        "search.alpha_label": "向量 vs 關鍵字 權重",
        "search.alpha_help": "0 = 純關鍵字，1 = 純向量，0.5 = 平衡",
        "search.results_label": "結果數量",
        "search.results_help": "要擷取的文件片段數量",
        "search.weight_caption": "📝 關鍵字：{kw}% ｜ 🎯 向量：{vec}%",
        "chat.header": "💬 提問",
        "chat.input": "就你的檔案提出問題…",
        "buttons.clear_chat": "🔄 清除對話",
        "chat.response_metrics": "📊 回應指標",
        "chat.metrics_total_time": "總時間：{secs:.2f} 秒",
        "chat.metrics_first_token": "第一個 Token：{secs:.2f} 秒",
        "chat.metrics_tokens": "Token 數：{count}",
        "chat.metrics_speed": "速度：{rate:.1f} tokens/sec",
        "footer.embedding_model": "Embedding 模型：",
        "footer.generation_model": "生成模型：",
        "chat.metric_response_time": "⏱️ 回應時間",
        "chat.metric_first_token": "🚀 第一個 Token",
        "chat.metric_tokens": "📝 Token 數",
        "chat.metric_speed": "⚡ 速度",
        "chat.searching": "🔍 正在搜尋檔案…",
        "chat.found_chunks": "✅ 找到 {count} 個相關片段，用時 {secs:.2f} 秒",
        "chat.found_chunks_hybrid": "（混合：{kw} 關鍵字 + {vec} 向量）",
        "chat.found_chunks_keyword": "（關鍵字：{kw} 筆）",
        "chat.found_chunks_vector": "（向量：{vec} 筆）",
        "chat.sources": "📖 來源",
        "chat.search_completed": "搜尋完成，用時 {secs:.2f} 秒，模式：{mode}",
        "chat.thinking": "🤔 思考中…",
        "chat.streaming": "🔄 串流中…",
        "chat.complete": "✅ 完成",
        "chat.error_generating": "產生回應時發生錯誤：{err}",
        "chat.no_relevant": "找不到相關內容，請先確認已索引檔案。",
        "chat.no_relevant_title": "⚠️ 找不到相關文件",
        "lang.selector": "🌐 語言",
        "lang.en": "English",
        "lang.zh_hant": "繁體中文",
        "lang.zh_hans": "简体中文",
        "lang.es": "西班牙文",
        "lang.ja": "日文",

        "settings.title": "⚙️ 設定",
        "settings.doc_processing": "📊 文件處理設定",
        "settings.quick_presets": "🎯 快速預設",
        "settings.quick_presets_caption": "最佳化常見文件：Notion/飛書匯出、PDF、技術文件",
        "settings.preset_meeting": "📝 會議紀錄",
        "settings.preset_prd": "📋 PRD/規格",
        "settings.preset_tech": "💻 技術文件",
        "settings.preset_wiki": "📚 Wiki/知識庫",
        "settings.preset_applied_meeting": "📝 已套用：會議紀錄",
        "settings.preset_applied_prd": "📋 已套用：PRD/規格",
        "settings.preset_applied_tech": "💻 已套用：技術文件",
        "settings.preset_applied_wiki": "📚 已套用：Wiki/知識庫",
        "settings.chunk_size": "📏 片段大小（每段字元數）",
        "settings.chunk_help": "混合內容建議 1500–1800。",
        "settings.overlap_size": "🔄 重疊大小（片段間共用文字）",
        "settings.overlap_help": "含程式碼區塊的文件建議 300–400。",
        "settings.results": "🔍 搜尋結果數（相關片段數量）",
        "settings.results_help": "技術問題用 5–7，簡單問答用 3–5。",
        "settings.current_config": "📊 目前設定",
        "settings.metric_chunk": "片段大小",
        "settings.metric_overlap": "重疊",
        "settings.metric_results": "結果",
        "settings.small_good": "⚠️ 小：適合問答",
        "settings.large_good": "📦 大：適合程式碼",
        "settings.balanced": "✅ 平衡",
        "settings.overlap_pct": "重疊占比 {pct:.0f}%",
        "settings.focused": "🎯 精準搜尋",
        "settings.comprehensive": "🌐 全面",
        "settings.best_practices": "💡 最佳實務",
        "settings.bp_notion_title": "📌 Notion/飛書匯出：",
        "settings.bp_notion_list": "- 請匯出為 Markdown（.md）\n- Notion：Settings → Export → Markdown & CSV\n- 飛書/Feishu/Lark：更多 → 匯出 → Markdown",
        "settings.bp_reco_title": "📊 建議設定：",
        "settings.bp_reco_list": "- 會議紀錄：600–800，重疊 100\n- PRD/規格：1500，重疊 300\n- 技術文件：1800，重疊 400\n- Wiki/教學：1200，重疊 200",
        "settings.prompt": "提示詞（Prompt）",
        "settings.prompt_active": "使用中的系統提示檔：",
        "settings.preview_first300": "預覽前 300 字",
        "settings.prompt_not_found": "找不到提示檔；改用內建預設。",
        "settings.prompt_could_not_read": "無法讀取提示檔：{err}",
        "settings.reload_prompt": "🔁 重新載入系統提示",
        "settings.reload_ok": "已重新載入。",
        "settings.reload_fail": "重新載入失敗：{err}",
        "settings.reload_na": "目前無法重新載入提示。",
        "settings.models": "模型",
        "settings.ollama_prereq": "⚠️ 需要先準備：\n1. 安裝 Ollama：`brew install ollama`\n2. 啟動：`ollama serve`\n3. 下載模型：\n   - `ollama pull embeddinggemma:300m`\n   - `ollama pull gpt-oss:20b`",
        "settings.embed_model": "Embedding 模型",
        "settings.gen_model": "生成模型",
        "settings.model_help": "請先在 Ollama 安裝該模型",
        "settings.check_ollama": "🔍 檢查 Ollama 狀態",
    },
    "zh-Hans": {
        "app.subtitle": "免费、本地的文件伙伴——把文件放进 `documents/` 就能开始提问。",
        "sidebar.document_management": "📁 文件管理",
        "sidebar.documents_folder": "📂 文件夹：`./{folder}/`",
        "sidebar.index_new_docs": "🔄 建立新索引",
        "sidebar.found_docs": "找到 {count} 个文件",
        "sidebar.auto_detect": "🤖 AI 智能自动识别",
        "sidebar.auto_detect_help": "使用 LLM 识别文档类型与语言。",
        "sidebar.auto_detect_caption1": "✨ AI 会分析每个文件并自动调整处理设置",
        "sidebar.auto_detect_caption2": "🌐 支持 English / 简体中文 / 繁體中文 / Español / 日本語 及混合内容",
        "sidebar.no_docs_found": "在 `./{folder}/` 找不到文件",
        "sidebar.supported_formats_title": "支持格式：",
        "sidebar.vision_support_title": "🎨 图像识别：",
        "sidebar.vision_support_detail": "✅ 通过 LLaVA 处理 PDF 图片、图表与截图",
        "sidebar.supported_formats_list": "PDF、Word、Markdown、HTML、CSV、Excel、JSON、TXT 等",
        "sidebar.indexed_docs": "📊 已索引文件",
        "sidebar.reset_index": "🧹 重置索引",
        "sidebar.reset_index_help": "清除 LanceDB 表并重置 Tantivy 索引",
        "sidebar.no_index_yet": "尚未建立任何索引",
        "sidebar.total_chunks": "总片段数",
        "sidebar.reset_ok": "索引已重置。",
        "sidebar.reset_fail": "重置失败。你也可以手动删除 .lancedb 文件夹后重新加载。",
        "sidebar.tantivy_warn": "Tantivy 清除警告：{err}",
        "search.header": "🔍 搜索设置",
        "search.mode": "搜索模式",
        "search.mode_help": "混合搜索结合关键字与向量，更聪明",
        "search.alpha_label": "向量 vs 关键字 权重",
        "search.alpha_help": "0 = 纯关键字，1 = 纯向量，0.5 = 平衡",
        "search.results_label": "结果数量",
        "search.results_help": "要获取的文档片段数量",
        "search.weight_caption": "📝 关键字：{kw}% ｜ 🎯 向量：{vec}%",
        "chat.header": "💬 提问",
        "chat.input": "就你的文件提出问题…",
        "buttons.clear_chat": "🔄 清除对话",
        "chat.response_metrics": "📊 响应指标",
        "chat.metrics_total_time": "总时间：{secs:.2f} 秒",
        "chat.metrics_first_token": "第一个 Token：{secs:.2f} 秒",
        "chat.metrics_tokens": "Token 数：{count}",
        "chat.metrics_speed": "速度：{rate:.1f} tokens/sec",
        "footer.embedding_model": "Embedding 模型：",
        "footer.generation_model": "生成模型：",
        "chat.metric_response_time": "⏱️ 响应时间",
        "chat.metric_first_token": "🚀 第一个 Token",
        "chat.metric_tokens": "📝 Token 数",
        "chat.metric_speed": "⚡ 速度",
        "chat.searching": "🔍 正在搜索文件…",
        "chat.found_chunks": "✅ 找到 {count} 个相关片段，用时 {secs:.2f} 秒",
        "chat.found_chunks_hybrid": "（混合：{kw} 关键字 + {vec} 向量）",
        "chat.found_chunks_keyword": "（关键字：{kw} 条）",
        "chat.found_chunks_vector": "（向量：{vec} 条）",
        "chat.sources": "📖 来源",
        "chat.search_completed": "搜索完成，用时 {secs:.2f} 秒，模式：{mode}",
        "chat.thinking": "🤔 思考中…",
        "chat.streaming": "🔄 流式输出中…",
        "chat.complete": "✅ 完成",
        "chat.error_generating": "生成回答时发生错误：{err}",
        "chat.no_relevant": "找不到相关内容，请先确认已建立索引。",
        "chat.no_relevant_title": "⚠️ 找不到相关文件",
        "lang.selector": "🌐 语言",
        "lang.en": "English",
        "lang.zh_hant": "繁體中文",
        "lang.zh_hans": "简体中文",
        "lang.es": "西班牙语",
        "lang.ja": "日语",

        "settings.title": "⚙️ 设置",
        "settings.doc_processing": "📊 文档处理设置",
        "settings.quick_presets": "🎯 快速预设",
        "settings.quick_presets_caption": "优化常见文档：Notion/飞书导出、PDF、技术文档",
        "settings.preset_meeting": "📝 会议记录",
        "settings.preset_prd": "📋 PRD/规格",
        "settings.preset_tech": "💻 技术文档",
        "settings.preset_wiki": "📚 Wiki/知识库",
        "settings.preset_applied_meeting": "📝 已应用：会议记录",
        "settings.preset_applied_prd": "📋 已应用：PRD/规格",
        "settings.preset_applied_tech": "💻 已应用：技术文档",
        "settings.preset_applied_wiki": "📚 已应用：Wiki/知识库",
        "settings.chunk_size": "📏 片段大小（每段字符数）",
        "settings.chunk_help": "混合内容推荐 1500–1800。",
        "settings.overlap_size": "🔄 重叠大小（片段间共享文本）",
        "settings.overlap_help": "含代码块的文档推荐 300–400。",
        "settings.results": "🔍 搜索结果数（相关片段数量）",
        "settings.results_help": "技术问题用 5–7，简单问答用 3–5。",
        "settings.current_config": "📊 当前设置",
        "settings.metric_chunk": "片段大小",
        "settings.metric_overlap": "重叠",
        "settings.metric_results": "结果",
        "settings.small_good": "⚠️ 小：适合问答",
        "settings.large_good": "📦 大：适合代码",
        "settings.balanced": "✅ 平衡",
        "settings.overlap_pct": "重叠占比 {pct:.0f}%",
        "settings.focused": "🎯 精准搜索",
        "settings.comprehensive": "🌐 全面",
        "settings.best_practices": "💡 最佳实践",
        "settings.bp_notion_title": "📌 Notion/飞书导出：",
        "settings.bp_notion_list": "- 请导出为 Markdown（.md）\n- Notion：Settings → Export → Markdown & CSV\n- 飞书/Feishu/Lark：更多 → 导出 → Markdown",
        "settings.bp_reco_title": "📊 建议设置：",
        "settings.bp_reco_list": "- 会议记录：600–800，重叠 100\n- PRD/规格：1500，重叠 300\n- 技术文档：1800，重叠 400\n- Wiki/教程：1200，重叠 200",
        "settings.prompt": "提示词（Prompt）",
        "settings.prompt_active": "使用中的系统提示文件：",
        "settings.preview_first300": "预览前 300 字",
        "settings.prompt_not_found": "找不到提示文件；改用内置默认。",
        "settings.prompt_could_not_read": "无法读取提示文件：{err}",
        "settings.reload_prompt": "🔁 重新加载系统提示",
        "settings.reload_ok": "已重新加载。",
        "settings.reload_fail": "重新加载失败：{err}",
        "settings.reload_na": "目前无法重新加载提示。",
        "settings.models": "模型",
        "settings.ollama_prereq": "⚠️ 需要先准备：\n1. 安装 Ollama：`brew install ollama`\n2. 启动：`ollama serve`\n3. 下载模型：\n   - `ollama pull embeddinggemma:300m`\n   - `ollama pull gpt-oss:20b`",
        "settings.embed_model": "Embedding 模型",
        "settings.gen_model": "生成模型",
        "settings.model_help": "请先在 Ollama 安装该模型",
        "settings.check_ollama": "🔍 检查 Ollama 状态",
    },
    "es": {
        "app.subtitle": "Compañero local y gratuito para tus documentos — pon archivos en `documents/` y pregunta al instante.",
        "sidebar.document_management": "📁 Gestión de Documentos",
        "sidebar.documents_folder": "📂 Carpeta de documentos: `./{folder}/`",
        "sidebar.index_new_docs": "🔄 Indexar nuevos documentos",
        "sidebar.found_docs": "Se encontraron {count} documento(s)",
        "sidebar.auto_detect": "🤖 Detección automática con IA",
        "sidebar.auto_detect_help": "Usa un LLM para detectar tipos e idiomas de documentos.",
        "sidebar.auto_detect_caption1": "✨ La IA analiza cada documento para ajustar el procesamiento",
        "sidebar.auto_detect_caption2": "🌐 Compatible con English, 中文 (简/繁), Español, 日本語",
        "sidebar.no_docs_found": "No se encontraron documentos en `./{folder}/`",
        "sidebar.supported_formats_title": "Formatos compatibles:",
        "sidebar.vision_support_title": "🎨 Soporte de visión:",
        "sidebar.vision_support_detail": "✅ Imágenes, gráficos y capturas en PDF (LLaVA)",
        "sidebar.supported_formats_list": "PDF, Word, Markdown, HTML, CSV, Excel, JSON, TXT, etc.",
        "sidebar.indexed_docs": "📊 Documentos indexados",
        "sidebar.reset_index": "🧹 Reiniciar índice",
        "sidebar.reset_index_help": "Eliminar la tabla de LanceDB y limpiar el índice Tantivy",
        "sidebar.no_index_yet": "Aún no hay documentos indexados",
        "sidebar.total_chunks": "Fragmentos totales",
        "sidebar.reset_ok": "Índice reiniciado correctamente.",
        "sidebar.reset_fail": "Error al reiniciar. Puedes borrar la carpeta .lancedb y recargar.",
        "sidebar.tantivy_warn": "Advertencia al limpiar Tantivy: {err}",
        "search.header": "🔍 Configuración de búsqueda",
        "search.mode": "Modo de búsqueda",
        "search.mode_help": "Híbrido combina palabras clave y búsqueda vectorial",
        "search.alpha_label": "Peso: Vector vs Palabras clave",
        "search.alpha_help": "0 = Solo palabras clave, 1 = Solo vectorial, 0.5 = Balanceado",
        "search.results_label": "Número de resultados",
        "search.results_help": "Cantidad de fragmentos a recuperar",
        "search.weight_caption": "📝 Palabras clave: {kw}% | 🎯 Vector: {vec}%",
        "chat.header": "💬 Haz preguntas",
        "chat.input": "Haz una pregunta sobre tus documentos…",
        "buttons.clear_chat": "🔄 Limpiar chat",
        "chat.response_metrics": "📊 Métricas de respuesta",
        "chat.metrics_total_time": "Tiempo total: {secs:.2f}s",
        "chat.metrics_first_token": "Primer token: {secs:.2f}s",
        "chat.metrics_tokens": "Tokens: {count}",
        "chat.metrics_speed": "Velocidad: {rate:.1f} tokens/seg",
        "footer.embedding_model": "Modelo de embedding:",
        "footer.generation_model": "Modelo de generación:",
        "chat.metric_response_time": "⏱️ Tiempo de respuesta",
        "chat.metric_first_token": "🚀 Primer token",
        "chat.metric_tokens": "📝 Tokens",
        "chat.metric_speed": "⚡ Velocidad",
        "chat.searching": "🔍 Buscando en los documentos…",
        "chat.found_chunks": "✅ {count} fragmentos relevantes en {secs:.2f}s",
        "chat.found_chunks_hybrid": " (Híbrido: {kw} palabras clave + {vec} vector)",
        "chat.found_chunks_keyword": " (Palabras clave: {kw} resultados)",
        "chat.found_chunks_vector": " (Vector: {vec} resultados)",
        "chat.sources": "📖 Fuentes",
        "chat.search_completed": "Búsqueda completada en {secs:.2f}s (modo {mode})",
        "chat.thinking": "🤔 Pensando…",
        "chat.streaming": "🔄 Transmitiendo…",
        "chat.complete": "✅ Completado",
        "chat.error_generating": "Error generando la respuesta: {err}",
        "chat.no_relevant": "No encontré información relevante en los documentos indexados. Asegúrate de indexarlos.",
        "chat.no_relevant_title": "⚠️ No se encontraron documentos relevantes",
        "lang.selector": "🌐 Idioma",
        "lang.en": "English",
        "lang.zh_hant": "繁體中文",
        "lang.zh_hans": "简体中文",
        "lang.es": "Español",
        "lang.ja": "日本語",

        "settings.title": "⚙️ Ajustes",
        "settings.doc_processing": "📊 Ajustes de procesamiento de documentos",
        "settings.quick_presets": "🎯 Ajustes rápidos",
        "settings.quick_presets_caption": "Optimizado para Notion/Lark, PDFs y docs técnicos",
        "settings.preset_meeting": "📝 Actas/Reuniones",
        "settings.preset_prd": "📋 PRD/Especificaciones",
        "settings.preset_tech": "💻 Documentación técnica",
        "settings.preset_wiki": "📚 Wiki/KB",
        "settings.preset_applied_meeting": "📝 Preajuste aplicado: Reuniones",
        "settings.preset_applied_prd": "📋 Preajuste aplicado: PRD/Especificaciones",
        "settings.preset_applied_tech": "💻 Preajuste aplicado: Documentación técnica",
        "settings.preset_applied_wiki": "📚 Preajuste aplicado: Wiki/KB",
        "settings.chunk_size": "📏 Tamaño de fragmento (caracteres por segmento)",
        "settings.chunk_help": "Para Notion/Lark con contenido mixto: 1500–1800 recomendado.",
        "settings.overlap_size": "🔄 Superposición (texto compartido entre fragmentos)",
        "settings.overlap_help": "Con bloques de código: usar 300–400.",
        "settings.results": "🔍 Resultados de búsqueda (fragmentos relevantes)",
        "settings.results_help": "Consultas técnicas 5–7; Q&A simple 3–5.",
        "settings.current_config": "📊 Configuración actual",
        "settings.metric_chunk": "Tamaño de fragmento",
        "settings.metric_overlap": "Superposición",
        "settings.metric_results": "Resultados",
        "settings.small_good": "⚠️ Pequeño: bueno para Q&A",
        "settings.large_good": "📦 Grande: bueno para código",
        "settings.balanced": "✅ Equilibrado",
        "settings.overlap_pct": "{pct:.0f}% del tamaño de fragmento",
        "settings.focused": "🎯 Búsqueda enfocada",
        "settings.comprehensive": "🌐 Integral",
        "settings.best_practices": "💡 Buenas prácticas",
        "settings.bp_notion_title": "📌 Exportación Notion/Lark:",
        "settings.bp_notion_list": "- Exporta a Markdown (.md)\n- Notion: Settings → Export → Markdown & CSV\n- Lark/Feishu: More → Export → Markdown",
        "settings.bp_reco_title": "📊 Configuración recomendada:",
        "settings.bp_reco_list": "- Reuniones: 600–800, superposición 100\n- PRD/Especificaciones: 1500, superposición 300\n- Técnica: 1800, superposición 400\n- Wiki/How-to: 1200, superposición 200",
        "settings.prompt": "Prompt",
        "settings.prompt_active": "Archivo de prompt activo:",
        "settings.preview_first300": "Previsualizar primeros 300 caracteres",
        "settings.prompt_not_found": "No se encontró el archivo de prompt; se usa el predeterminado.",
        "settings.prompt_could_not_read": "No se pudo leer el prompt: {err}",
        "settings.reload_prompt": "🔁 Recargar prompt del sistema",
        "settings.reload_ok": "Prompt recargado.",
        "settings.reload_fail": "Error al recargar: {err}",
        "settings.reload_na": "No es posible recargar el prompt ahora.",
        "settings.models": "Modelos",
        "settings.ollama_prereq": "⚠️ Requisitos previos:\n1. Instala Ollama: `brew install ollama`\n2. Inicia: `ollama serve`\n3. Descarga modelos:\n   - `ollama pull embeddinggemma:300m`\n   - `ollama pull gpt-oss:20b`",
        "settings.embed_model": "Modelo de embedding",
        "settings.gen_model": "Modelo generativo",
        "settings.model_help": "Asegúrate de que el modelo esté instalado en Ollama",
        "settings.check_ollama": "🔍 Verificar estado de Ollama",
    },
    "ja": {
        "app.subtitle": "無料・ローカルのドキュメント相棒 — `documents/` に入れて質問するだけ。",
        "sidebar.document_management": "📁 ドキュメント管理",
        "sidebar.documents_folder": "📂 ドキュメントフォルダ: `./{folder}/`",
        "sidebar.index_new_docs": "🔄 新しいドキュメントをインデックス",
        "sidebar.found_docs": "{count} 件のドキュメントを検出",
        "sidebar.auto_detect": "🤖 AI 自動判別",
        "sidebar.auto_detect_help": "LLM がドキュメントの種類と言語を判別します。",
        "sidebar.auto_detect_caption1": "✨ 各ドキュメントを解析して処理を最適化",
        "sidebar.auto_detect_caption2": "🌐 English・中文(简/繁)・Español・日本語 に対応",
        "sidebar.no_docs_found": "`./{folder}/` にドキュメントが見つかりません",
        "sidebar.supported_formats_title": "対応フォーマット:",
        "sidebar.vision_support_title": "🎨 画像理解:",
        "sidebar.vision_support_detail": "✅ LLaVA により PDF の画像・図・スクショに対応",
        "sidebar.supported_formats_list": "PDF、Word、Markdown、HTML、CSV、Excel、JSON、TXT など",
        "sidebar.indexed_docs": "📊 インデックス済みドキュメント",
        "sidebar.reset_index": "🧹 インデックスをリセット",
        "sidebar.reset_index_help": "LanceDB テーブル削除と Tantivy のクリア",
        "sidebar.no_index_yet": "まだインデックスがありません",
        "sidebar.total_chunks": "合計チャンク数",
        "sidebar.reset_ok": "インデックスをリセットしました。",
        "sidebar.reset_fail": "リセットに失敗しました。.lancedb フォルダを削除して再読み込みしてください。",
        "sidebar.tantivy_warn": "Tantivy クリア警告: {err}",
        "search.header": "🔍 検索設定",
        "search.mode": "検索モード",
        "search.mode_help": "ハイブリッドはキーワードとベクトルを併用",
        "search.alpha_label": "ベクトル vs キーワード 重み",
        "search.alpha_help": "0 = キーワードのみ, 1 = ベクトルのみ, 0.5 = バランス",
        "search.results_label": "結果の件数",
        "search.results_help": "取得するドキュメント断片の数",
        "search.weight_caption": "📝 キーワード: {kw}% | 🎯 ベクトル: {vec}%",
        "chat.header": "💬 質問する",
        "chat.input": "ドキュメントについて質問…",
        "buttons.clear_chat": "🔄 チャットをクリア",
        "chat.response_metrics": "📊 応答メトリクス",
        "chat.metrics_total_time": "合計時間: {secs:.2f}s",
        "chat.metrics_first_token": "最初のトークン: {secs:.2f}s",
        "chat.metrics_tokens": "トークン数: {count}",
        "chat.metrics_speed": "速度: {rate:.1f} tokens/秒",
        "footer.embedding_model": "Embedding モデル:",
        "footer.generation_model": "生成モデル:",
        "chat.metric_response_time": "⏱️ 応答時間",
        "chat.metric_first_token": "🚀 最初のトークン",
        "chat.metric_tokens": "📝 トークン数",
        "chat.metric_speed": "⚡ 速度",
        "chat.searching": "🔍 ドキュメントを検索中…",
        "chat.found_chunks": "✅ 関連チャンク {count} 件（{secs:.2f}s）",
        "chat.found_chunks_hybrid": "（ハイブリッド: キーワード {kw} + ベクトル {vec}）",
        "chat.found_chunks_keyword": "（キーワード: {kw} 件）",
        "chat.found_chunks_vector": "（ベクトル: {vec} 件）",
        "chat.sources": "📖 参照元",
        "chat.search_completed": "検索完了 {secs:.2f}s（{mode} モード）",
        "chat.thinking": "🤔 考え中…",
        "chat.streaming": "🔄 ストリーミング中…",
        "chat.complete": "✅ 完了",
        "chat.error_generating": "応答の生成でエラー: {err}",
        "chat.no_relevant": "インデックス済みドキュメントに関連情報が見つかりませんでした。まずインデックスしてください。",
        "chat.no_relevant_title": "⚠️ 関連ドキュメントが見つかりません",
        "lang.selector": "🌐 言語",
        "lang.en": "English",
        "lang.zh_hant": "繁體中文",
        "lang.zh_hans": "简体中文",
        "lang.es": "Español",
        "lang.ja": "日本語",

        "settings.title": "⚙️ 設定",
        "settings.doc_processing": "📊 ドキュメント処理の設定",
        "settings.quick_presets": "🎯 かんたんプリセット",
        "settings.quick_presets_caption": "Notion/Lark のエクスポート、PDF、技術文書に最適化",
        "settings.preset_meeting": "📝 会議メモ",
        "settings.preset_prd": "📋 PRD/仕様",
        "settings.preset_tech": "💻 技術文書",
        "settings.preset_wiki": "📚 Wiki/ナレッジ",
        "settings.preset_applied_meeting": "📝 適用: 会議メモ",
        "settings.preset_applied_prd": "📋 適用: PRD/仕様",
        "settings.preset_applied_tech": "💻 適用: 技術文書",
        "settings.preset_applied_wiki": "📚 適用: Wiki/ナレッジ",
        "settings.chunk_size": "📏 チャンクサイズ（1 セグメントの文字数）",
        "settings.chunk_help": "混在コンテンツには 1500–1800 を推奨。",
        "settings.overlap_size": "🔄 オーバーラップ（チャンク間の共有テキスト）",
        "settings.overlap_help": "コードブロックを含む文書は 300–400 を推奨。",
        "settings.results": "🔍 検索結果（関連セグメント数）",
        "settings.results_help": "技術的な質問 5–7、簡単な Q&A 3–5。",
        "settings.current_config": "📊 現在の設定",
        "settings.metric_chunk": "チャンクサイズ",
        "settings.metric_overlap": "オーバーラップ",
        "settings.metric_results": "結果",
        "settings.small_good": "⚠️ 小: Q&A 向け",
        "settings.large_good": "📦 大: コード向け",
        "settings.balanced": "✅ バランス",
        "settings.overlap_pct": "チャンク比 {pct:.0f}%",
        "settings.focused": "🎯 集中検索",
        "settings.comprehensive": "🌐 網羅的",
        "settings.best_practices": "💡 ベストプラクティス",
        "settings.bp_notion_title": "📌 Notion/Lark の書き出し:",
        "settings.bp_notion_list": "- 最高の結果には Markdown (.md) で書き出し\n- Notion: Settings → Export → Markdown & CSV\n- Lark/Feishu: More → Export → Markdown",
        "settings.bp_reco_title": "📊 推奨設定:",
        "settings.bp_reco_list": "- 会議メモ: 600–800、オーバーラップ 100\n- PRD/仕様: 1500、オーバーラップ 300\n- 技術文書: 1800、オーバーラップ 400\n- Wiki/How-to: 1200、オーバーラップ 200",
        "settings.prompt": "プロンプト",
        "settings.prompt_active": "使用中のシステムプロンプト:",
        "settings.preview_first300": "先頭 300 文字をプレビュー",
        "settings.prompt_not_found": "プロンプトが見つかりません。デフォルトを使用します。",
        "settings.prompt_could_not_read": "プロンプトを読み込めませんでした: {err}",
        "settings.reload_prompt": "🔁 システムプロンプトを再読み込み",
        "settings.reload_ok": "再読み込みしました。",
        "settings.reload_fail": "再読み込みに失敗しました: {err}",
        "settings.reload_na": "今はプロンプトを再読み込みできません。",
        "settings.models": "モデル",
        "settings.ollama_prereq": "⚠️ 事前準備:\n1. Ollama をインストール: `brew install ollama`\n2. 起動: `ollama serve`\n3. モデルを取得:\n   - `ollama pull embeddinggemma:300m`\n   - `ollama pull gpt-oss:20b`",
        "settings.embed_model": "Embedding モデル",
        "settings.gen_model": "生成モデル",
        "settings.model_help": "Ollama にモデルがインストールされていることを確認してください",
        "settings.check_ollama": "🔍 Ollama の状態を確認",
    },
}


def get_locale() -> str:
    return st.session_state.get("locale", "en")


def set_locale(locale: str) -> None:
    if locale in _TRANSLATIONS:
        st.session_state["locale"] = locale


def t(key: str, default: str | None = None, **kwargs) -> str:
    locale = get_locale()
    catalog = _TRANSLATIONS.get(locale, _TRANSLATIONS["en"])  # fallback to en
    text = catalog.get(key)
    if text is None:
        # fallback chain: default -> en -> key
        text = default or _TRANSLATIONS["en"].get(key, key)
    try:
        return text.format(**kwargs)
    except Exception:
        return text
